name: Build

on:
  workflow_call:
    inputs:
      configuration:
        description: 'Build configuration (Debug or Release)'
        type: string
        default: 'Release'
    outputs:
      artifact-name:
        description: 'Name of the uploaded build artifact'
        value: ${{ jobs.build.outputs.artifact-name }}

env:
  SIMHUB_VERSION: '9.11.3'

jobs:
  build:
    runs-on: windows-latest
    outputs:
      artifact-name: ${{ steps.package.outputs.artifact-name }}

    steps:
      - uses: actions/checkout@v4

      - name: Cache SimHub dependencies
        id: cache-simhub
        uses: actions/cache@v4
        with:
          path: ${{ runner.temp }}/simhub-deps
          key: simhub-${{ env.SIMHUB_VERSION }}

      - name: Download and extract SimHub dependencies
        if: steps.cache-simhub.outputs.cache-hit != 'true'
        shell: pwsh
        run: |
          $version = $env:SIMHUB_VERSION
          $url = "https://github.com/SHWotever/SimHub/releases/download/$version/SimHub.$version.zip"
          $zipPath = "$env:RUNNER_TEMP\SimHub.zip"
          Write-Host "Downloading SimHub $version from $url ..."
          Invoke-WebRequest -Uri $url -OutFile $zipPath -UseBasicParsing
          Write-Host "Extracting to $env:RUNNER_TEMP\simhub-deps ..."
          Expand-Archive -Path $zipPath -DestinationPath "$env:RUNNER_TEMP\simhub-deps" -Force
          Remove-Item $zipPath

      - name: Configure SimHub dependency path
        shell: pwsh
        run: |
          $extractPath = "$env:RUNNER_TEMP\simhub-deps"

          # Locate the directory that contains the SimHub plugin DLLs.
          # The ZIP may place files at the root or inside a single sub-folder.
          $probe = Get-ChildItem $extractPath -Filter 'SimHub.Plugins.dll' -Recurse -ErrorAction SilentlyContinue |
                   Select-Object -First 1
          if (-not $probe) {
            Write-Error "SimHub.Plugins.dll not found under $extractPath"
            exit 1
          }
          $simhubDir = $probe.DirectoryName
          Write-Host "SimHub DLLs located at: $simhubDir"

          # Write Directory.Build.props.user so MSBuild picks up the staged DLLs.
          $xml = @"
          <Project>
            <PropertyGroup>
              <SimHubDir>$simhubDir\</SimHubDir>
            </PropertyGroup>
          </Project>
          "@
          $xml | Set-Content "$env:GITHUB_WORKSPACE\Directory.Build.props.user"

      - name: Restore NuGet packages
        run: dotnet restore FanaBridge\FanaBridge.csproj

      - name: Build
        run: dotnet build FanaBridge\FanaBridge.csproj -c ${{ inputs.configuration }} --no-restore

      - name: Test
        run: dotnet test FanaBridge.sln --no-build --verbosity normal
        continue-on-error: true

      - name: Package artifact
        id: package
        shell: pwsh
        run: |
          $config   = '${{ inputs.configuration }}'
          $binDir   = "FanaBridge\bin\$config"
          $dist     = 'dist'
          $staging  = "$dist\staging"

          New-Item $staging                      -ItemType Directory -Force | Out-Null
          New-Item "$staging\DevicesLogos"       -ItemType Directory -Force | Out-Null

          Copy-Item "$binDir\FanaBridge.dll" $staging

          $processedLogos = 'FanaBridge\Resources\DeviceLogos\processed'
          if (Test-Path $processedLogos) {
            Get-ChildItem "$processedLogos\*.png" -ErrorAction SilentlyContinue | ForEach-Object {
              Copy-Item $_.FullName "$staging\DevicesLogos\$($_.Name)"
            }
          }

          $fileVersion = (Get-Item "$staging\FanaBridge.dll").VersionInfo.FileVersion
          if ([string]::IsNullOrWhiteSpace($fileVersion)) { $fileVersion = 'dev' }
          $archiveName = "FanaBridge-$fileVersion-$config.zip"
          $archivePath = "$dist\$archiveName"

          Compress-Archive -Path "$staging\*" -DestinationPath $archivePath -Force
          Remove-Item $staging -Recurse -Force

          "artifact-name=$archiveName" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          Write-Host "Packaged: $archivePath"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.package.outputs.artifact-name }}
          path: dist/*.zip
          if-no-files-found: error
